/*!
 * 
 *  WebGazer.js: Scalable Webcam EyeTracking Using User Interactions
 *  Copyright (c) 2016-2020, Brown HCI Group 
 *  Licensed under GPLv3. Companies with a valuation of less than $1M can use WebGazer.js under LGPLv3.
 *  
 */
module.exports=function(e){function t(t){for(var a,o,s=t[0],l=t[1],d=t[2],c=0,u=[];c<s.length;c++)o=s[c],Object.prototype.hasOwnProperty.call(i,o)&&i[o]&&u.push(i[o][0]),i[o]=0;for(a in l)Object.prototype.hasOwnProperty.call(l,a)&&(e[a]=l[a]);for(h&&h(t);u.length;)u.shift()();return n.push.apply(n,d||[]),r()}function r(){for(var e,t=0;t<n.length;t++){for(var r=n[t],a=!0,s=1;s<r.length;s++){var l=r[s];0!==i[l]&&(a=!1)}a&&(n.splice(t--,1),e=o(o.s=r[0]))}return e}var a={},i={0:0},n=[];function o(t){if(a[t])return a[t].exports;var r=a[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,o),r.l=!0,r.exports}o.m=e,o.c=a,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},o.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.t=function(e,t){if(1&t&&(e=o(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(o.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)o.d(r,a,function(t){return e[t]}.bind(null,a));return r},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="";var s=window.webpackJsonpwebgazer=window.webpackJsonpwebgazer||[],l=s.push.bind(s);s.push=t,s=s.slice();for(var d=0;d<s.length;d++)t(s[d]);var h=l;return n.push([90,1]),r()}({63:function(e,t){},64:function(e,t){},75:function(e,t){},78:function(e,t){},79:function(e,t){},90:function(e,t,r){"use strict";r.r(t);r(60),r(80);var a={moveTickSize:50,videoContainerId:"webgazerVideoContainer",videoElementId:"webgazerVideoFeed",videoElementCanvasId:"webgazerVideoCanvas",faceOverlayId:"webgazerFaceOverlay",faceFeedbackBoxId:"webgazerFaceFeedbackBox",gazeDotId:"webgazerGazeDot",videoViewerWidth:320,videoViewerHeight:240,faceFeedbackBoxRatio:.66,showVideo:!0,mirrorVideo:!0,showFaceOverlay:!0,showFaceFeedbackBox:!0,showGazeDot:!0,camConstraints:{video:{width:{min:320,ideal:640,max:1920},height:{min:240,ideal:480,max:1080},facingMode:"user"}},dataTimestep:50,showVideoPreview:!0,applyKalmanFilter:!0,saveDataAcrossSessions:!0,storingPoints:!1};window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){return window.setTimeout(e,1e3/60)},window.cancelRequestAnimFrame=window.cancelCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.clearTimeout;var i=r(32),n=r(59);const o=function(){this.model=n.load({maxFaces:1}),this.predictionReady=!1};o.prototype.positionsArray=null,o.prototype.getEyePatches=async function(e,t,r){if(0===e.width)return null;const a=await this.model,i=await a.estimateFaces(e);if(0==i.length)return!1;this.positionsArray=i[0].scaledMesh;const n=this.positionsArray;var o=Math.round(Math.min(n[247][0],n[130][0],n[25][0])),s=Math.round(Math.min(n[247][1],n[27][1],n[190][1])),l=Math.round(Math.max(n[190][0],n[243][0],n[233][0])-o),d=Math.round(Math.max(n[25][1],n[23][1],n[112][1])-s),h=Math.round(Math.min(n[414][0],n[463][0],n[453][0])),c=Math.round(Math.min(n[414][1],n[257][1],n[467][1])),u=Math.round(Math.max(n[467][0],n[359][0],n[255][0])-h),g=Math.round(Math.max(n[341][1],n[253][1],n[255][1])-c);if(0===l||0===u)return console.log("an eye patch had zero width"),null;if(0===d||0===g)return console.log("an eye patch had zero height"),null;var p={},y=e.getContext("2d").getImageData(o,s,l,d);p.left={patch:y,imagex:o,imagey:s,width:l,height:d};var f=e.getContext("2d").getImageData(h,c,u,g);return p.right={patch:f,imagex:h,imagey:c,width:u,height:g},this.predictionReady=!0,p},o.prototype.getPositions=function(){return this.positionsArray},o.prototype.reset=function(){console.log("Unimplemented; Tracking.js has no obvious reset function")},o.prototype.drawFaceOverlay=function(e,t){if(t){e.fillStyle="#32EEDB",e.strokeStyle="#32EEDB",e.lineWidth=.5;for(let r=0;r<t.length;r++){const a=t[r][0],i=t[r][1];e.beginPath(),e.arc(a,i,1,0,2*Math.PI),e.closePath(),e.fill()}}},o.prototype.name="TFFaceMesh";var s=o;const l={transpose:function(e){for(var t=e.length,r=e[0].length,a=new Array(r),i=0;i<t;i++)for(var n=0;n<r;n++)0===i&&(a[n]=new Array(t)),a[n][i]=e[i][n];return a},getMatrix:function(e,t,r,a){for(var i=new Array(t.length),n=a-r+1,o=0;o<t.length;o++){i[o]=new Array(n);for(var s=r;s<=a;s++)i[o][s-r]=e[t[o]][s]}return i},getSubMatrix:function(e,t,r,a,i){for(var n=i-a+1,o=new Array(r-t+1),s=t;s<=r;s++){var l=s-t;o[l]=new Array(n);for(var d=a;d<=i;d++)o[l][d-a]=e[s][d]}return o},mult:function(e,t){t.length!=e[0].length&&console.log("Matrix inner dimensions must agree:");for(var r=new Array(e.length),a=new Array(e[0].length),i=0;i<t[0].length;i++){for(var n=0;n<e[0].length;n++)a[n]=t[n][i];for(var o=0;o<e.length;o++){0===i&&(r[o]=new Array(t[0].length));var s=e[o],l=0;for(n=0;n<e[0].length;n++)l+=s[n]*a[n];r[o][i]=l}}return r},LUDecomposition:function(e,t){for(var r=new Array(e.length),a=0;a<e.length;a++){r[a]=new Array(e[0].length);for(var i=0;i<e[0].length;i++)r[a][i]=e[a][i]}var n=e.length,o=e[0].length,s=new Array(n);for(a=0;a<n;a++)s[a]=a;var l=1,d=new Array,h=new Array(n);for(i=0;i<o;i++){for(a=0;a<n;a++)h[a]=r[a][i];for(a=0;a<n;a++){d=r[a];for(var c=Math.min(a,i),u=0,g=0;g<c;g++)u+=d[g]*h[g];d[i]=h[a]-=u}var p=i;for(a=i+1;a<n;a++)Math.abs(h[a])>Math.abs(h[p])&&(p=a);if(p!=i){for(g=0;g<o;g++){var y=r[p][g];r[p][g]=r[i][g],r[i][g]=y}g=s[p];s[p]=s[i],s[i]=g,l=-l}if(i<n&0!=r[i][i])for(a=i+1;a<n;a++)r[a][i]/=r[i][i]}t.length!=n&&console.log("Matrix row dimensions must agree.");for(i=0;i<o;i++)0===r[i][i]&&console.log("Matrix is singular.");var f=t[0].length,m=self.webgazer.mat.getMatrix(t,s,0,f-1);for(g=0;g<o;g++)for(a=g+1;a<o;a++)for(i=0;i<f;i++)m[a][i]-=m[g][i]*r[a][g];for(g=o-1;g>=0;g--){for(i=0;i<f;i++)m[g][i]/=r[g][g];for(a=0;a<g;a++)for(i=0;i<f;i++)m[a][i]-=m[g][i]*r[a][g]}return m},QRDecomposition:function(e,t){for(var r=new Array(e.length),a=0;a<e.length;a++){r[a]=new Array(e[0].length);for(var i=0;i<e[0].length;i++)r[a][i]=e[a][i]}for(var n,o=e.length,s=e[0].length,d=new Array(s),h=0;h<s;h++){n=0;for(a=h;a<o;a++)n=Math.hypot(n,r[a][h]);if(0!=n){r[h][h]<0&&(n=-n);for(a=h;a<o;a++)r[a][h]/=n;r[h][h]+=1;for(i=h+1;i<s;i++){var c=0;for(a=h;a<o;a++)c+=r[a][h]*r[a][i];c=-c/r[h][h];for(a=h;a<o;a++)r[a][i]+=c*r[a][h]}}d[h]=-n}t.length!=o&&console.log("Matrix row dimensions must agree.");for(i=0;i<s;i++)0===d[i]&&console.log("Matrix is rank deficient");var u=t[0].length,g=new Array(t.length);for(a=0;a<t.length;a++)g[a]=new Array(t[0].length);for(a=0;a<t.length;a++)for(i=0;i<t[0].length;i++)g[a][i]=t[a][i];for(h=0;h<s;h++)for(i=0;i<u;i++){for(c=0,a=h;a<o;a++)c+=r[a][h]*g[a][i];c=-c/r[h][h];for(a=h;a<o;a++)g[a][i]+=c*r[a][h]}for(h=s-1;h>=0;h--){for(i=0;i<u;i++)g[h][i]/=d[h];for(a=0;a<h;a++)for(i=0;i<u;i++)g[a][i]-=g[h][i]*r[a][h]}return l.getSubMatrix(g,0,s-1,0,u-1)}};var d=l,h=r(14);const c={};c.Eye=function(e,t,r,a,i){this.patch=e,this.imagex=t,this.imagey=r,this.width=a,this.height=i},c.getEyeFeats=function(e){var t=this.resizeEye(e.left,10,6),r=this.resizeEye(e.right,10,6),a=this.grayscale(t.data,t.width,t.height),i=this.grayscale(r.data,r.width,r.height),n=[];this.equalizeHistogram(a,5,n);var o=[];this.equalizeHistogram(i,5,o);Array.prototype.slice.call(n),Array.prototype.slice.call(o);return n.concat(o)},c.DataWindow=function(e,t){this.data=[],this.windowSize=e,this.index=0,this.length=0,t&&(this.data=t.slice(t.length-e,t.length),this.length=this.data.length)},c.DataWindow.prototype.push=function(e){return this.data.length<this.windowSize?(this.data.push(e),this.length=this.data.length,this):(this.data[this.index]=e,this.index=(this.index+1)%this.windowSize,this)},c.DataWindow.prototype.get=function(e){return this.data[this.getTrueIndex(e)]},c.DataWindow.prototype.getTrueIndex=function(e){return this.data.length<this.windowSize?e:(e+this.index)%this.windowSize},c.DataWindow.prototype.addAll=function(e){for(var t=0;t<e.length;t++)this.push(e[t])},c.grayscale=function(e,t,r){for(var a=new Uint8ClampedArray(e.length>>2),i=0,n=0,o=0;o<r;o++)for(var s=0;s<t;s++){var l=.299*e[n]+.587*e[n+1]+.114*e[n+2];a[i++]=l,n+=4}return a},c.equalizeHistogram=function(e,t,r){var a=e.length;r||(r=e),t||(t=5);for(var i=Array(256).fill(0),n=0;n<a;n+=t)++i[e[n]];var o=255*t/a,s=0;for(n=0;n<256;++n){var l=i[n];s=l+=s,i[n]=l*o}for(n=0;n<a;++n)r[n]=i[e[n]];return r},c.threshold=function(e,t){for(let r=0;r<e.length;r++)e[r]=e[r]>t?255:0;return e},c.correlation=function(e,t){const r=Math.min(e.length,t.length);let a=0;for(let i=0;i<r;i++)e[i]===t[i]&&a++;return a/Math.max(e.length,t.length)},c.resizeEye=function(e,t,r){var a=document.createElement("canvas");a.width=e.width,a.height=e.height,a.getContext("2d").putImageData(e.patch,0,0);var i=document.createElement("canvas");return i.width=t,i.height=r,i.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,t,r),i.getContext("2d").getImageData(0,0,t,r)},c.bound=function(e){e.x<0&&(e.x=0),e.y<0&&(e.y=0);var t=Math.max(document.documentElement.clientWidth,window.innerWidth||0),r=Math.max(document.documentElement.clientHeight,window.innerHeight||0);return e.x>t&&(e.x=t),e.y>r&&(e.y=r),e},c.DebugBox=function(e){var t;this.para=document.createElement("p"),this.div=document.createElement("div"),this.div.appendChild(this.para),document.body.appendChild(this.div),this.buttons={},this.canvas={},this.stats={},t=this,setInterval((function(){!function(e,t){var r="";for(var a in t)r+=a+": "+t[a]+"\n";e.innerText=r}(t.para,t.stats)}),e||300)},c.DebugBox.prototype.set=function(e,t){this.stats[e]=t},c.DebugBox.prototype.inc=function(e,t,r){this.stats[e]||(this.stats[e]=r||0),this.stats[e]+=t||1},c.DebugBox.prototype.addButton=function(e,t){this.buttons[e]||(this.buttons[e]=document.createElement("button"),this.div.appendChild(this.buttons[e]));var r=this.buttons[e];this.buttons[e]=r,r.addEventListener("click",t),r.innerText=e},c.DebugBox.prototype.show=function(e,t){this.canvas[e]||(this.canvas[e]=document.createElement("canvas"),this.div.appendChild(this.canvas[e]));var r=this.canvas[e];r.getContext("2d").clearRect(0,0,r.width,r.height),t(r)};var u=c;const g={InitRegression:function(){this.ridgeParameter=Math.pow(10,-5),this.errorXArray=new u.DataWindow(700),this.errorYArray=new u.DataWindow(700),this.screenXClicksArray=new u.DataWindow(700),this.screenYClicksArray=new u.DataWindow(700),this.eyeFeaturesClicks=new u.DataWindow(700),this.trailTime=1e3,this.trailDataWindow=this.trailTime/a.moveTickSize,this.screenXTrailArray=new u.DataWindow(10),this.screenYTrailArray=new u.DataWindow(10),this.eyeFeaturesTrail=new u.DataWindow(10),this.trailTimes=new u.DataWindow(10),this.dataClicks=new u.DataWindow(700),this.dataTrail=new u.DataWindow(10);var e=[[1/4,0,.5,0],[0,1/4,0,.5],[.5,0,1,0],[0,.5,0,1]];e=h.mul(e,.1);var t=h.mul(h.identity(2),47),r=h.mul(h.identity(4),1e-4);this.kalman=new g.KalmanFilter([[1,0,1,0],[0,1,0,1],[0,0,1,0],[0,0,0,1]],[[1,0,0,0],[0,1,0,0]],e,t,r,[[500],[500],[0],[0]])},KalmanFilter:function(e,t,r,a,i,n){this.F=e,this.Q=r,this.H=t,this.R=a,this.P=i,this.X=n}};g.KalmanFilter.prototype.update=function(e){for(var t=h.add,r=h.sub,a=h.inv,i=h.identity,n=d.mult,o=d.transpose,s=n(this.F,this.X),l=t(n(n(this.F,this.P),o(this.F)),this.Q),c=r(e,n(this.H,s)),u=t(n(n(this.H,l),o(this.H)),this.R),g=n(l,n(o(this.H),a(u))),p=0;p<c.length;p++)c[p]=[c[p]];return this.X=t(s,n(g,c)),this.P=n(r(i(g.length),n(g,this.H)),l),o(n(this.H,this.X))[0]},g.ridge=function(e,t,r){var a=t[0].length,i=new Array(a),n=d.transpose(t),o=new Array,s=!0;do{for(var l=d.mult(n,t),c=0;c<a;c++)l[c][c]=l[c][c]+r;var u=d.mult(n,e);for(c=0;c<a;c++)i[c]=u[c][0];try{var g=0!==i.length?i.length/i.length:0;i.length*g!==i.length&&console.log("Array length must be a multiple of m"),o=l.length===l[0].length?h.LUsolve(h.LU(l,!0),u):webgazer.mat.QRDecomposition(l,u);for(c=0;c<a;c++)i[c]=o[c];s=!0}catch(e){r*=10,console.log(e),s=!1}}while(!s);return i},g.setData=function(e){for(var t=0;t<e.length;t++){var r=new Uint8ClampedArray(e[t].eyes.left.patch.data),a=new Uint8ClampedArray(e[t].eyes.right.patch.data);e[t].eyes.left.patch=new ImageData(r,e[t].eyes.left.width,e[t].eyes.left.height),e[t].eyes.right.patch=new ImageData(a,e[t].eyes.right.width,e[t].eyes.right.height),this.addData(e[t].eyes,e[t].screenPos,e[t].type)}},g.getCurrentFixationIndex=function(){for(var e=this.screenXTrailArray.get(0),t=this.screenYTrailArray.get(0),r=this.screenXTrailArray.length-1;r>=0;r--){var a=this.screenXTrailArray.get(r),i=this.screenYTrailArray.get(r);if(Math.sqrt(Math.pow(a-e,2)+Math.pow(i-t,2))>72)return r+1}return r},g.addData=function(e,t,r){e&&("click"===r?(this.screenXClicksArray.push([t[0]]),this.screenYClicksArray.push([t[1]]),this.eyeFeaturesClicks.push(u.getEyeFeats(e)),this.dataClicks.push({eyes:e,screenPos:t,type:r})):"move"===r&&(this.screenXTrailArray.push([t[0]]),this.screenYTrailArray.push([t[1]]),this.eyeFeaturesTrail.push(u.getEyeFeats(e)),this.trailTimes.push(performance.now()),this.dataTrail.push({eyes:e,screenPos:t,type:r})))};var p=g;const y={RidgeReg:function(){this.init()}};y.RidgeReg.prototype.init=p.InitRegression,y.RidgeReg.prototype.addData=p.addData,y.RidgeReg.prototype.predict=function(e){if(!e||0===this.eyeFeaturesClicks.length)return null;for(var t=performance.now()-this.trailTime,r=[],i=[],n=[],o=0;o<this.trailDataWindow;o++)this.trailTimes.get(o)>t&&(r.push(this.screenXTrailArray.get(o)),i.push(this.screenYTrailArray.get(o)),n.push(this.eyeFeaturesTrail.get(o)));var s=this.screenXClicksArray.data.concat(r),l=this.screenYClicksArray.data.concat(i),d=this.eyeFeaturesClicks.data.concat(n),h=p.ridge(s,d,this.ridgeParameter),c=p.ridge(l,d,this.ridgeParameter),g=u.getEyeFeats(e),y=0;for(o=0;o<g.length;o++)y+=g[o]*h[o];var f=0;for(o=0;o<g.length;o++)f+=g[o]*c[o];if(y=Math.floor(y),f=Math.floor(f),a.applyKalmanFilter){var m=[y,f];return{x:(m=this.kalman.update(m))[0],y:m[1]}}return{x:y,y:f}},y.RidgeReg.prototype.setData=p.setData,y.RidgeReg.prototype.getData=function(){return this.dataClicks.data},y.RidgeReg.prototype.name="ridge";var f=y;const m={RidgeWeightedReg:function(){this.init()}};m.RidgeWeightedReg.prototype.init=p.InitRegression,m.RidgeWeightedReg.prototype.addData=p.addData,m.RidgeWeightedReg.prototype.predict=function(e){if(!e||0===this.eyeFeaturesClicks.length)return null;for(var t=performance.now()-this.trailTime,r=[],i=[],n=[],o=0;o<this.trailDataWindow;o++)this.trailTimes.get(o)>t&&(r.push(this.screenXTrailArray.get(o)),i.push(this.screenYTrailArray.get(o)),n.push(this.eyeFeaturesTrail.get(o)));var s=this.eyeFeaturesClicks.data.length,l=Array(s),d=Array(s),h=Array(s);for(o=0;o<s;o++){for(var c=Math.sqrt(1/(s-o)),g=this.eyeFeaturesClicks.getTrueIndex(o),y=0;y<this.eyeFeaturesClicks.data[g].length;y++){var f=this.eyeFeaturesClicks.data[g][y]*c;void 0!==l[g]?l[g].push(f):l[g]=[f]}d[g]=this.screenXClicksArray.get(o).slice(0,this.screenXClicksArray.get(o).length),h[g]=this.screenYClicksArray.get(o).slice(0,this.screenYClicksArray.get(o).length),d[o][0]=d[o][0]*c,h[o][0]=h[o][0]*c}var m=d.concat(r),w=h.concat(i),v=l.concat(n),x=p.ridge(m,v,this.ridgeParameter),b=p.ridge(w,v,this.ridgeParameter),k=u.getEyeFeats(e),F=0;for(o=0;o<k.length;o++)F+=k[o]*x[o];var R=0;for(o=0;o<k.length;o++)R+=k[o]*b[o];if(F=Math.floor(F),R=Math.floor(R),a.applyKalmanFilter){var D=[F,R];return{x:(D=this.kalman.update(D))[0],y:D[1]}}return{x:F,y:R}},m.RidgeWeightedReg.prototype.setData=p.setData,m.RidgeWeightedReg.prototype.getData=function(){return this.dataClicks.data},m.RidgeWeightedReg.prototype.name="ridgeWeighted";var w=m;const v={};Math.pow(10,-5);var x={X:[0],Y:[0]};v.RidgeRegThreaded=function(){this.init()},v.RidgeRegThreaded.prototype.init=function(){this.screenXClicksArray=new u.DataWindow(700),this.screenYClicksArray=new u.DataWindow(700),this.eyeFeaturesClicks=new u.DataWindow(700),this.screenXTrailArray=new u.DataWindow(10),this.screenYTrailArray=new u.DataWindow(10),this.eyeFeaturesTrail=new u.DataWindow(10),this.dataClicks=new u.DataWindow(700),this.dataTrail=new u.DataWindow(700),this.worker||(this.worker=new Worker("ridgeWorker.mjs"),this.worker.onerror=function(e){console.log(e.message)},this.worker.onmessage=function(e){x.X=e.data.X,x.Y=e.data.Y},console.log("initialized worker"));var e=[[1/4,0,.5,0],[0,1/4,0,.5],[.5,0,1,0],[0,.5,0,1]];e=h.mul(e,.1);var t=h.mul(h.identity(2),47),r=h.mul(h.identity(4),1e-4);this.kalman=new p.KalmanFilter([[1,0,1,0],[0,1,0,1],[0,0,1,0],[0,0,0,1]],[[1,0,0,0],[0,1,0,0]],e,t,r,[[500],[500],[0],[0]])},v.RidgeRegThreaded.prototype.addData=function(e,t,r){e&&this.worker.postMessage({eyes:u.getEyeFeats(e),screenPos:t,type:r})},v.RidgeRegThreaded.prototype.predict=function(e){if(!e)return null;for(var t=x.X,r=x.Y,i=u.getEyeFeats(e),n=0,o=0,s=0;s<i.length;s++)n+=i[s]*t[s],o+=i[s]*r[s];if(n=Math.floor(n),o=Math.floor(o),a.applyKalmanFilter){var l=[n,o];return{x:(l=this.kalman.update(l))[0],y:l[1]}}return{x:n,y:o}},v.RidgeRegThreaded.prototype.setData=p.setData,v.RidgeRegThreaded.prototype.getData=function(){return this.dataClicks.data},v.RidgeRegThreaded.prototype.name="ridge";var b=v;const k={tracker:{}};k.tracker.TFFaceMesh=s,k.reg=f,k.reg.RidgeWeightedReg=w.RidgeWeightedReg,k.reg.RidgeRegThreaded=b.RidgeRegThreaded,k.util=u,k.params=a;var F=null,R=null,D=null,A=null,C=null,M=null,T=null,W="",P=new Array(50),z=new Array(50),E=performance.now(),V=null,I=null,S=!1,O=function(e,t){},H=O,X=["click","move"],B=performance.now(),Y=new k.tracker.TFFaceMesh,q=[new k.reg.RidgeReg],U={TFFacemesh:function(){return new k.tracker.TFFaceMesh}},G={ridge:function(){return new k.reg.RidgeReg},weightedRidge:function(){return new k.reg.RidgeWeightedReg},threadedRidge:function(){return new k.reg.RidgeRegThreaded}},L={},j=[],K={data:[],settings:{}};async function _(e){var t=[];if(V=await function(e,t,r){if(e)try{return Y.getEyePatches(e,t,r)}catch(e){return console.log("can't get pupil features ",e),null}}(A,A.width,A.height),0===q.length)return console.log("regression not set, call setRegression()"),null;for(var r in q)t.push(q[r].predict(V));return void 0!==e?null===t[e]?null:{x:t[e].x,y:t[e].y,eyeFeatures:V}:0===t.length||null===t[0]?null:{x:t[0].x,y:t[0].y,eyeFeatures:V,all:t}}k.computeValidationBoxSize=function(){var e=D.videoWidth,t=D.videoHeight,r=parseInt(D.style.width),a=parseInt(D.style.height),i=Math.min(e,t),n=e==Math.max(e,t)?r/e:a/t,o=i*k.params.faceFeedbackBoxRatio*n;return[(a-o)/2,(r-o)/2,o,o]};var Q=new u.DataWindow(4),J=0;async function N(){if(!S){s=A,l=A.width,d=A.height,s.width!=l&&(s.width=l),s.height!=d&&(s.height=d),s.getContext("2d").drawImage(D,0,0,s.width,s.height),I=_();var e=performance.now()-E;if(k.params.showFaceOverlay){var t=k.getTracker();C.getContext("2d").clearRect(0,0,D.videoWidth,D.videoHeight),t.drawFaceOverlay(C.getContext("2d"),t.getPositions())}if(k.params.showFaceFeedbackBox&&function(){if(null!=M&&V){var e=D.videoWidth,t=D.videoHeight,r=Math.min(e,t)*k.params.faceFeedbackBoxRatio,a=(t-r)/2,i=(e-r)/2,n=i+r,o=a+r,s=V.left.imagex,l=V.left.imagey,d=V.right.imagex,h=V.right.imagey,c=!1,u=!1;s>i&&s<n&&d>i&&d<n&&(c=!0),l>a&&l<o&&h>a&&h<o&&(u=!0),M.style.border=c&&u?"solid green":"solid red"}else M.style.border="solid black"}(),I=await I,H(I,e),I){Q.push(I);var r=0,a=0,i=Q.length;for(var n in Q.data)r+=Q.get(n).x,a+=Q.get(n).y;var o=u.bound({x:r/i,y:a/i});k.params.storingPoints&&(!function(e,t,r){var a=document.getElementById("plotting_canvas").getContext("2d");a.fillStyle=e,a.beginPath(),a.arc(t,r,5,0,2*Math.PI,!0),a.fill()}("blue",o.x,o.y),k.storePoints(o.x,o.y,J),50==++J&&(J=0)),k.params.showGazeDot&&(T.style.display="block"),T.style.transform="translate3d("+o.x+"px,"+o.y+"px,0)"}else T.style.display="none";requestAnimationFrame(N)}var s,l,d}var Z=function(e,t,r){if(!S){if(0===q.length)return console.log("regression not set, call setRegression()"),null;for(var a in q)V&&q[a].addData(V,[e,t],r)}},$=async function(e){Z(e.clientX,e.clientY,X[0]),k.params.saveDataAcrossSessions&&await async function(){var e=q[0].getData()||j;i.setItem("webgazerGlobalSettings",L),i.setItem("webgazerGlobalData",e)}()},ee=function(e){if(!S){var t=performance.now();t<B+k.params.moveTickSize||(B=t,Z(e.clientX,e.clientY,X[1]))}},te=function(){document.addEventListener("click",$,!0),document.addEventListener("mousemove",ee,!0)};async function re(e){F=e,(R=document.createElement("div")).id=k.params.videoContainerId,R.style.display=k.params.showVideo?"block":"none",R.style.position="fixed",R.style.top="0px",R.style.left="0px",R.style.width=k.params.videoViewerWidth+"px",R.style.height=k.params.videoViewerHeight+"px",(D=document.createElement("video")).setAttribute("playsinline",""),D.id=k.params.videoElementId,D.srcObject=e,D.autoplay=!0,D.style.display=k.params.showVideo?"block":"none",D.style.position="absolute",D.style.width=k.params.videoViewerWidth+"px",D.style.height=k.params.videoViewerHeight+"px",(A=document.createElement("canvas")).id=k.params.videoElementCanvasId,A.style.display="none",(C=document.createElement("canvas")).id=k.params.faceOverlayId,C.style.display=k.params.showFaceOverlay?"block":"none",C.style.position="absolute",k.params.mirrorVideo&&(D.style.setProperty("-moz-transform","scale(-1, 1)"),D.style.setProperty("-webkit-transform","scale(-1, 1)"),D.style.setProperty("-o-transform","scale(-1, 1)"),D.style.setProperty("transform","scale(-1, 1)"),D.style.setProperty("filter","FlipH"),C.style.setProperty("-moz-transform","scale(-1, 1)"),C.style.setProperty("-webkit-transform","scale(-1, 1)"),C.style.setProperty("-o-transform","scale(-1, 1)"),C.style.setProperty("transform","scale(-1, 1)"),C.style.setProperty("filter","FlipH")),(M=document.createElement("canvas")).id=k.params.faceFeedbackBoxId,M.style.display=k.params.showFaceFeedbackBox?"block":"none",M.style.border="solid",M.style.position="absolute",(T=document.createElement("div")).id=k.params.gazeDotId,T.style.display=k.params.showGazeDot?"block":"none",T.style.position="fixed",T.style.zIndex=99999,T.style.left="-5px",T.style.top="-5px",T.style.background="red",T.style.borderRadius="100%",T.style.opacity="0.7",T.style.width="10px",T.style.height="10px",R.appendChild(D),document.body.appendChild(R),D.addEventListener("timeupdate",(function e(t){ae(D.videoWidth,D.videoHeight),k.setVideoViewerSize(k.params.videoViewerWidth,k.params.videoViewerHeight),R.appendChild(A),R.appendChild(C),R.appendChild(M),document.body.appendChild(T),t.target.removeEventListener(t.type,e)})),te(),S=!1,E=performance.now(),await N()}function ae(e,t){A&&(A.width=e,A.height=t),C&&(C.width=e,C.height=t)}k.begin=function(e){return"https:"!==window.location.protocol&&"localhost"!==window.location.hostname&&window.chrome&&alert("WebGazer works only over https. If you are doing local development, you need to run a local server."),k.params.saveDataAcrossSessions&&async function(){L=(L=await i.getItem("webgazerGlobalSettings"))||K;var e=await i.getItem("webgazerGlobalData");for(var t in j=e=e||K,q)q[t].setData(e);console.log("loaded stored data into regression model")}(),e=e||function(){console.log("No stream")},W?(re(W),k):(void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e){var t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise((function(r,a){t.call(navigator,e,r,a)})):Promise.reject(new Error("Unfortunately, your browser does not support access to the webcam through the getUserMedia API. Try to use the latest version of Google Chrome, Mozilla Firefox, Opera, or Microsoft Edge instead."))}),new Promise(async(t,r)=>{let a;try{a=await navigator.mediaDevices.getUserMedia(k.params.camConstraints),re(a),t(k)}catch(t){e(),D=null,a=null,r(t)}}))},k.isReady=function(){return null!==A&&A.width>0},k.pause=function(){return S=!0,k},k.resume=async function(){return S?(S=!1,await N(),k):k},k.end=function(){return S=!0,document.body.removeChild(D),document.body.removeChild(A),k},k.stopVideo=function(){return F.getTracks()[0].stop(),document.body.removeChild(C),document.body.removeChild(M),k},k.detectCompatibility=function(){return void 0!==(navigator.mediaDevices.getUserMedia||navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia)},k.showVideoPreview=function(e){return k.params.showVideoPreview=e,k.showVideo(e&&k.params.showVideo),k.showFaceOverlay(e&&k.params.showFaceOverlay),k.showFaceFeedbackBox(e&&k.params.showFaceFeedbackBox),k},k.showVideo=function(e){return k.params.showVideo=e,D&&(D.style.display=e?"block":"none"),R&&(R.style.display=e?"block":"none"),k},k.showFaceOverlay=function(e){return k.params.showFaceOverlay=e,C&&(C.style.display=e?"block":"none"),k},k.showFaceFeedbackBox=function(e){return k.params.showFaceFeedbackBox=e,M&&(M.style.display=e?"block":"none"),k},k.showPredictionPoints=function(e){return k.params.showGazeDot=e,T&&(T.style.display=e?"block":"none"),k},k.saveDataAcrossSessions=function(e){return k.params.saveDataAcrossSessions=e,k},k.applyKalmanFilter=function(e){return k.params.applyKalmanFilter=e,k},k.setCameraConstraints=async function(e){var t,r;if(k.params.camConstraints=e,F){k.pause(),t=F.getVideoTracks()[0];try{await t.applyConstraints(k.params.camConstraints),ae((r=t.getSettings()).width,r.height)}catch(e){return void console.log(e)}k.setVideoViewerSize(k.params.videoViewerWidth,k.params.videoViewerHeight),k.getTracker().reset(),await k.resume()}},k.setStaticVideo=function(e){return W=e,k},k.setVideoViewerSize=function(e,t){k.params.videoViewerWidth=e,k.params.videoViewerHeight=t,D.style.width=e+"px",D.style.height=t+"px",C.style.width=e+"px",C.style.height=t+"px";var r=k.computeValidationBoxSize();M.style.top=r[0]+"px",M.style.left=r[1]+"px",M.style.width=r[2]+"px",M.style.height=r[3]+"px"},k.addMouseEventListeners=function(){return te(),k},k.removeMouseEventListeners=function(){return document.removeEventListener("click",$,!0),document.removeEventListener("mousemove",ee,!0),k},k.recordScreenPosition=function(e,t){return Z(e,t,X[0]),k},k.recordScreenPosition=function(e,t,r){return Z(e,t,r),k},k.storePoints=function(e,t,r){P[r]=e,z[r]=t},k.setTracker=function(e){if(void 0===U[e]){for(var t in console.log("Invalid tracker selection"),console.log("Options are: "),U)console.log(t);return k}return Y=U[e](),k},k.setRegression=function(e){if(void 0===G[e]){for(var t in console.log("Invalid regression selection"),console.log("Options are: "),G)console.log(t);return k}return j=q[0].getData(),(q=[G[e]()])[0].setData(j),k},k.addTrackerModule=function(e,t){U[e]=function(){return new t}},k.addRegressionModule=function(e,t){G[e]=function(){return new t}},k.addRegression=function(e){var t=G[e]();return j=q[0].getData(),t.setData(j),q.push(t),k},k.setGazeListener=function(e){return H=e,k},k.clearGazeListener=function(){return H=O,k},k.setVideoElementCanvas=function(e){A=e},k.clearData=async function(){!function(){for(var e in i.clear(),q)q[e].init()}()},k.getTracker=function(){return Y},k.getRegression=function(){return q},k.getCurrentPrediction=function(e){return _(e)},k.params.getEventTypes=function(){return X.slice()},k.getVideoElementCanvas=function(){return A},k.getVideoPreviewToCameraResolutionRatio=function(){return[k.params.videoViewerWidth/D.videoWidth,k.params.videoViewerHeight/D.videoHeight]},k.getStoredPoints=function(){return[P,z]};t.default=k}}).default;
//# sourceMappingURL=webgazer.commonjs2.min.js.map